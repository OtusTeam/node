# nodejs-process


my-domen.com - фронт
my-domen.com/api/v1 - API


Running 15s test @ http://localhost:4000
100 connections


┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬────────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max    │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼────────┤
│ Latency │ 4 ms │ 4 ms │ 8 ms  │ 9 ms │ 4.61 ms │ 1.49 ms │ 184 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬──────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg      │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┤
│ Req/Sec   │ 16815   │ 16815   │ 20159   │ 20799   │ 19829.87 │ 1080.54 │ 16805   │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┤
│ Bytes/Sec │ 4.74 MB │ 4.74 MB │ 5.69 MB │ 5.87 MB │ 5.59 MB  │ 305 kB  │ 4.74 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴──────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.
# of samples: 15

298k requests in 15.03s, 83.9 MB read

nik@nik:~/projects/webinar/node/2024-10/14 - process-management$ node ./src/stress-test.js 
Running 15s test @ http://localhost:4000
100 connections


┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 1 ms │ 2 ms │ 5 ms  │ 7 ms │ 2.12 ms │ 1.39 ms │ 45 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬──────────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg      │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┤
│ Req/Sec   │ 25007   │ 25007   │ 38303   │ 46623   │ 38240.54 │ 6461.22 │ 24999   │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼─────────┼─────────┤
│ Bytes/Sec │ 7.05 MB │ 7.05 MB │ 10.8 MB │ 13.1 MB │ 10.8 MB  │ 1.82 MB │ 7.05 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴──────────┴─────────┴─────────┘

Req/Bytes counts sampled once per second.
# of samples: 15

574k requests in 15.05s, 162 MB read







NodeJS process

- Как работает event loop?

loop - цикл.

- Процесс и поток? Что это?

Процесс.

// IPC 
// child_process

Поток.

// worker_threads


pm2 start app.js -i max

~/projects/webinar/nodejs-process (main ✗) autocannon http://localhost:4000/fast
Running 10s test @ http://localhost:4000/fast
10 connections


┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 0 ms │ 0 ms │ 2 ms  │ 3 ms │ 0.23 ms │ 0.57 ms │ 10 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬───────────┬────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg       │ Stdev  │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼───────────┼────────┼─────────┤
│ Req/Sec   │ 9,335   │ 9,335   │ 11,543  │ 11,727  │ 11,304.37 │ 652.53 │ 9,334   │
├───────────┼─────────┼─────────┼─────────┼─────────┼───────────┼────────┼─────────┤
│ Bytes/Sec │ 2.63 MB │ 2.63 MB │ 3.25 MB │ 3.31 MB │ 3.19 MB   │ 184 kB │ 2.63 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴───────────┴────────┴─────────┘

Req/Bytes counts sampled once per second.
# of samples: 11

124k requests in 11.01s, 35.1 MB read


Running 10s test @ http://localhost:4000/fast
10 connections


┌─────────┬──────┬──────┬───────┬──────┬─────────┬───────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼───────┼───────┤
│ Latency │ 0 ms │ 0 ms │ 2 ms  │ 4 ms │ 0.18 ms │ 1 ms  │ 47 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴───────┴───────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬──────────┬──────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg      │ Stdev    │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼──────────┼─────────┤
│ Req/Sec   │ 10,623  │ 10,623  │ 23,071  │ 28,095  │ 22,103.2 │ 4,866.98 │ 10,617  │
├───────────┼─────────┼─────────┼─────────┼─────────┼──────────┼──────────┼─────────┤
│ Bytes/Sec │ 2.99 MB │ 2.99 MB │ 6.51 MB │ 7.93 MB │ 6.23 MB  │ 1.37 MB  │ 2.99 MB │
└───────────┴─────────┴─────────┴─────────┴─────────┴──────────┴──────────┴─────────┘

Req/Bytes counts sampled once per second.
# of samples: 10

221k requests in 10.02s, 62.3 MB read






























# NodeJS Event loop.

Event Loop - механизм, который запуск выполнение различных задач в NodeJS

- Однопоточный - плохо справляется с синхронными задачи. await(асинхронный)
- Есть предел количества обрабатываемых задач на один сервер.

Масштабирования:

- Вертикальное масштабирование(CPU/mem/free space).
- Горизонтальное масштабирование в рамкам одной машинки - это запуск серверов на каждом CPU.
- Горизонтальное масштабирование на разных машинах - запускаем наши кластера на разных машинках(серверах).

Мы запускаем тот же сервер в несколько копий.

Если мы докидываем +1 сервер, не будет x2.

### Процессы и потоки

Процесс - это программа, запущенная на компьютере. Сами процессы могут порождать процессы.
Поток - это подпрграмма внутри процесса.

Про NodeJS, то с 0-ых версий Node.JS появилось возможность создавать процессы.
Потоки были использованы с версии 12-14

Процессы используют межпроцессорное взаимодействие.


















Приемущества:
- синхронные и асинхронные операции(блокирующие и не блокирующие операции для Event Loop).

Бизнес задача:
- обработать запрос.
- сходить в базу. // асинхронные await db.query('')
- сходить в сторонний API. // асинхронные await fetch('')
- сфомировать ответ.

Не нужно под каждый запрос, создавать подпроцесс/подпоток.

Недостатки:
- когда нужно сделать синхронную операции.
  - пройтись по массиву.
  - что-то посчитать(CPU intensive задача).
  - вычислить хэш(CPU intensive задача).

NodeJS не любит - синхронные задачи + CPU Intensive задачи.

// Варианты решения
// Решить вопрос на ходу(выполнять по чанкам и т.д.)
// Начать масштабироваться: вертикальное(добавить CPU, memory, free space) и горизонтальное(позволяет выполнять операции на разных CPU).


Процесс — это экземпляр запущенной программы. В операционной системе каждому процессу выделяются отдельные ресурсы (такие как память и процессорное время). Процессы работают изолированно друг от друга, что обеспечивает стабильность системы: сбой в одном процессе обычно не влияет на остальные.

Поток — это компонент процесса, который может быть выполнен операционной системой. Потоки внутри одного процесса могут делиться его ресурсами, такими как память и данные. Это позволяет потокам эффективно сотрудничать, но также требует синхронизации для предотвращения конфликтов.
